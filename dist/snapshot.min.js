/*! Snapshot.js by Adam Timberlake created on 2013-10-19 */
!function(a){"use strict";var b=require("crossfilter"),c=require("underscore"),d=function(a){this.namespace=a||"default"};d.prototype={namespace:"",crossfilter:null,dimensions:{},socket:null,primaryKey:"",memory:{},delta:!1,perPage:0,pageNumber:0,sorting:{key:"",direction:"ascending"},bootstrap:function(a){return this.socket=a,a.on(["snapshot",this.namespace,"perPage"].join("/"),function(a){this.setPerPage(a)}.bind(this)),a.on(["snapshot",this.namespace,"pageNumber"].join("/"),function(a){this.setPageNumber(a)}.bind(this)),a.on(["snapshot",this.namespace,"sortBy"].join("/"),function(a){this.setSortBy(a)}.bind(this)),this},useDelta:function(a){return this.delta=a,this},setCollection:function(a,d){this.crossfilter=b(a);var e=c.keys(a[0]);this.primaryKey=d||e[0],c.forEach(e,function(a){this.dimensions[a]=this.crossfilter.dimension(function(b){return b[a]})}.bind(this)),this._emitContentUpdated()},_emitContentUpdated:function(){if(this.crossfilter){var a="top";c.contains(["ascending","ascend","asc"],this.sorting.direction)&&(a="bottom");var b=(new Date).getTime(),d=this.dimensions[this.sorting.key][a](1/0),e=d.length,f=e/this.perPage<0?0:Math.ceil(e/this.perPage);if(0!==this.perPage){var g=this.pageNumber-1,h=g*this.perPage;d=d.slice(h,this.perPage+h)}if(this.delta){var i=c.pluck(d,this.primaryKey);c.forEach(d,function(a,b){var c=a[this.primaryKey];this.memory[c]&&(d[b]=c)}.bind(this)),c.forEach(i,function(a){this.memory[a]=a}.bind(this))}this.socket.emit(["snapshot",this.namespace,"contentUpdated"].join("/"),{models:d,stats:{pages:{total:c.isNumber(f)?f:1,current:this.pageNumber,perPage:this.perPage||d.length},models:{total:e,current:d.length},sort:{key:this.sorting.key,direction:this.sorting.direction}},debug:{responseTime:(new Date).getTime()-b}})}},setPerPage:function(a){this.perPage=a,this._emitContentUpdated()},setPageNumber:function(a){this.pageNumber=a,this._emitContentUpdated()},setSortBy:function(a){var b=function(){return"ascending"===this.sorting.direction?"descending":"ascending"}.bind(this);this.sorting={key:a.key,direction:a.direction||b()},this._emitContentUpdated()},applyFilter:function(a,b){var c=this.dimensions[a];c.filterAll(),b.call(this,c),this._emitContentUpdated()},clearFilter:function(a){var b=this.dimensions[a];b.filterAll(),this._emitContentUpdated()},clearFilters:function(){c.forEach(this.dimensions,function(a){a.filterAll()}),this._emitContentUpdated()}},a.exports=d}(module);