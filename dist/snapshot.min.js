/*! snapshot-js by Adam Timberlake created on 2013-10-29 */
!function(a){"use strict";var b=require("crossfilter"),c=require("underscore");require("colors");var d=function(a){this.namespace=a||"default",this.crossfilter=null,this.dimensions={},this.memory={},this.socket={emit:function(){this._printMessage("negative","You have not attached the socket.")}.bind(this)}};d.prototype={namespace:"",crossfilter:null,dimensions:{},socket:null,primaryKey:"",memory:{},lastPageNumber:1,delta:!1,perPage:0,pageNumber:1,ranges:[],sorting:{key:"",direction:"ascending"},bootstrap:function(a){return this.socket=a,a.on(["snapshot",this.namespace,"perPage"].join("/"),function(a){this.setPerPage(a),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"pageNumber"].join("/"),function(a){var b=this.setPageNumber(a);b&&this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"sortBy"].join("/"),function(a,b){this.setSortBy(a,b),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"exactFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){a.filterExact(b)}),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"fuzzyFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){var c=new RegExp(b,"i");a.filterFunction(function(a){return a.match(c)})}),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"rangeFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){a.filterRange(b)}),this._emitContentUpdated()}.bind(this)),this},useDelta:function(a){return this.delta=a,this},setCollection:function(a,d,e){this.crossfilter=b(a);var f=c.keys(a[0]);this.primaryKey=d||f[0],c.forEach(f,function(a){this.dimensions[a]=this.crossfilter.dimension(function(b){return b[a]})}.bind(this)),e||this._emitContentUpdated()},setRanges:function(a){c.isArray(a)||(a=[a]),this.ranges=a},_emitContentUpdated:function(){if(this.crossfilter){var a="top";c.contains(["ascending","ascend","asc"],this.sorting.direction)&&(a="bottom");var b=(new Date).getTime(),d=this.dimensions[this.sorting.key||this.primaryKey][a](1/0),e=d.length,f=this.lastPageNumber=Math.ceil(e/this.perPage)||1;if(0!==this.perPage){var g=this.pageNumber-1,h=g*this.perPage;d=d.slice(h,this.perPage+h)}if(this.delta){var i=c.pluck(d,this.primaryKey);c.forEach(d,function(a,b){var c=a[this.primaryKey];this.memory[c]&&(d[b]=c)}.bind(this)),c.forEach(i,function(a){this.memory[a]=a}.bind(this))}return this.pageNumber>f?(this.setPageNumber(f),this._emitContentUpdated(),void 0):(this.socket.emit(["snapshot",this.namespace,"contentUpdated"].join("/"),d,{pages:{total:f,current:this.pageNumber,perPage:this.perPage||d.length},models:{total:e,current:d.length},sort:{key:this.sorting.key,direction:this.sorting.direction},ranges:this._getRanges(),responseTime:(new Date).getTime()-b}),void 0)}},setPerPage:function(a){this.perPage=a>=0?a:0},setPageNumber:function(a){return!this.crossfilter&&a>0?(this.pageNumber=a,!1):0>=a||a>this.lastPageNumber?!1:(this.pageNumber=a,!0)},setSortBy:function(a,b){var c=function(){return"ascending"===this.sorting.direction?"descending":"ascending"}.bind(this);this.sorting={key:a,direction:b||c()}},applyFilter:function(a,b,d){d=d||"default";var e=["default","reduce"];c.contains(e,d)||(this._printMessage("Unsupported filter method: "+d+'. Defaulting to "default"',"negative"),d="default");var f=this.dimensions[a];return f?("default"===d&&f.filterAll(),b.call(this,f),this._emitContentUpdated(),void 0):(this._printMessage("negative",'Invalid column name found: "'+a+'".'),void 0)},clearFilter:function(a){var b=this.dimensions[a];return b?(b.filterAll(),this._emitContentUpdated(),void 0):(this._printMessage("negative",'Invalid column name found: "'+a+'".'),void 0)},clearFilters:function(){c.forEach(this.dimensions,function(a){a.filterAll()}),this._emitContentUpdated()},_printMessage:function(a,b){var c="";switch(a){case"positive":c="   ok    - ".green;break;case"negative":c="   error - ".red;break;case"neutral":c="   info  - ".cyan}console.log(c+"Snapshot.js - ".bold.grey+b.white)},_getRanges:function(){if(!this.ranges)return[];var a={};return c.forEach(this.ranges,function(b){var c=this.dimensions[b];if(c){var d=c.bottom(1)[0],e=c.top(1)[0];d&&e&&(a[b]={min:d[b],max:e[b]})}}.bind(this)),a}},a.exports=d}(module);