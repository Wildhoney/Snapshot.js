/*! node-snapshot by Adam Timberlake created on 2014-05-26 */
!function(a,b,c){"use strict";try{var d=require("crossfilter"),e=require("underscore")}catch(f){c.error("Cannot load dependencies. Please ensure you ran `npm install`.")}var g=function(a){this.namespace=a||"default",this.crossfilter=null,this.dimensions={},this.memory={},this.socket={emit:function(){this._printMessage("negative","You have not attached the socket.")}.bind(this)}};g.prototype={namespace:null,crossfilter:null,dimensions:{},partition:0,socket:null,primaryKey:"",allowEmit:!0,memory:{},modelCount:0,lastPageNumber:1,delta:!1,perPage:0,pageNumber:1,groups:[],ranges:[],sorting:{key:"",direction:"ascending"},bootstrap:function(a){return this.socket=a,a.on("disconnect",e.bind(function(){for(var a in this)this.hasOwnProperty(a)&&"function"!=typeof this[a]&&(this[a]=void 0)},this)),a.on(["snapshot",this.namespace,"perPage"].join("/"),function(a){this.setPerPage(a),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"pageNumber"].join("/"),function(a){var b=this.setPageNumber(a);b&&this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"sortBy"].join("/"),function(a,b){this.setSortBy(a,b),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"clearFilter"].join("/"),function(a){this.clearFilter(a),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"inArrayFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){a.filterFunction(function(a){return e.contains(b,a)})}),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"notInArrayFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){a.filterFunction(function(a){return!e.contains(b,a)})}),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"exactFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){a.filterExact(b)}),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"fuzzyFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){var c=new RegExp(b,"i");a.filterFunction(function(a){return a.match(c)})}),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"regExpFilter"].join("/"),function(a,b,c){var d=["/",b,"/"].join("");this.applyFilter(a,function(a){var b=new RegExp(d,c);a.filterFunction(function(a){return a.match(b)})}),this._emitContentUpdated()}.bind(this)),a.on(["snapshot",this.namespace,"rangeFilter"].join("/"),function(a,b){this.applyFilter(a,function(a){a.filterRange(b)}),this._emitContentUpdated()}.bind(this)),this},useDelta:function(a){return this.delta=!!a,this},pauseEmit:function(){this.allowEmit=!1},resumeEmit:function(a){this.allowEmit=!0,a&&this._emitContentUpdated()},setCollection:function(a,c,f,g,h){var i=(new Date).getTime();if(this.crossfilter=d(a),this.modelCount=a.length,c=c||e.keys(a[0]),this.primaryKey=f||c[0],e.forEach(c,function(a){var c=e.bind(function(){this.dimensions[a]=this.crossfilter.dimension(function(b){return b[a]})},this);return h?void c():void b.nextTick(c)}.bind(this)),!g){var j=e.bind(function(){this._emitContentUpdated(i)},this);if(h)return void j();b.nextTick(j)}},setPerPage:function(a){this.perPage=a>=0?a:0},setPageNumber:function(a){return!this.crossfilter&&a>0?(this.pageNumber=a,!1):0>=a||a>this.lastPageNumber?!1:(this.pageNumber=a,!0)},setSortBy:function(a,b){var c=function(){return"ascending"===this.sorting.direction?"descending":"ascending"}.bind(this);this.sorting={key:a,direction:b||c()}},setGroups:function(a){e.isArray(a)||(a=[a]),this.groups=a},setPartition:function(a){this.partition=a},setRanges:function(a){e.isArray(a)||(a=[a]),this.ranges=a},applyFilter:function(a,b,c){c=c||"afresh";var d=["afresh","reduce"],f=[];e.contains(d,c)||(this._printMessage("negative","Unsupported filter method: "+c+'. Defaulting to "default"'),c="afresh"),a=e.isArray(a)?a:[a],e.forEach(a,e.bind(function(a){var b=this.dimensions[a];return b?("afresh"===c&&b.filterAll(),void f.push(b)):void this._printMessage("negative",'Invalid column name found: "'+a+'".')},this)),b.apply(this,f),this._emitContentUpdated()},clearFilter:function(a){var b=this.dimensions[a];return b?(b.filterAll(),void this._emitContentUpdated()):void this._printMessage("negative",'Invalid column name found: "'+a+'".')},clearFilters:function(){e.forEach(this.dimensions,function(a){a.filterAll()}),this._emitContentUpdated()},_printMessage:function(a,b){var d="";switch(a){case"positive":d="   ok    - ".green;break;case"negative":d="   error - ".red;break;case"neutral":d="   info  - ".cyan}c.log(d+"Snapshot.js - ".bold.grey+b.white)},_getSortMethod:function(){return e.contains(["ascending","ascend","asc"],this.sorting.direction)?"bottom":"top"},_slice:function(a){isFinite(this.perPage)||(this.perPage=this.modelCount);var b=this.pageNumber-1,c=b*this.perPage;return a.slice(c,this.perPage+c)},_delta:function(a){var b=e.pluck(a,this.primaryKey);return e.forEach(a,function(b,c){var d=b[this.primaryKey];this.memory[d]&&(a[c]=d)}.bind(this)),e.forEach(b,function(a){this.memory[a]=a}.bind(this)),a},_emitContentUpdated:function(a){if(this.crossfilter&&this.allowEmit){var b=this._getSortMethod(),c=a||(new Date).getTime(),d=this.dimensions[this.sorting.key||this.primaryKey][b](1/0),e=d.length,f=this.lastPageNumber=Math.ceil(e/this.perPage)||1;if(0!==this.perPage&&(d=this._slice(d)),this.delta&&(d=this._delta(d)),this.pageNumber>f)return this.setPageNumber(f),void this._emitContentUpdated();var g={pages:{total:f,current:this.pageNumber,perPage:this.perPage||d.length},models:{total:e,current:d.length},sort:{key:this.sorting.key,direction:this.sorting.direction},ranges:this._getRanges(),groups:this._getGroups(),responseTime:(new Date).getTime()-c};this.socket.emit(["snapshot",this.namespace,"contentUpdated"].join("/"),d,g)}},_getGroups:function(){var a={};return e.forEach(this.groups,e.bind(function(b){var c=this.dimensions[b].group(function(a){return a});a[b]=c.all()},this)),a},_getRanges:function(){if(!this.ranges)return[];var a={};return e.forEach(this.ranges,function(b){var c=this.dimensions[b];if(c){var d=c.bottom(1)[0],e=c.top(1)[0];return d&&e?void(a[b]={min:d[b],max:e[b]}):void(a[b]={min:-1/0,max:1/0})}}.bind(this)),a}},a.exports=g}(module,process,console);