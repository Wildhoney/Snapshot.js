/*! Snapshot.js by Adam Timberlake created on 2013-10-18 */
!function(){"use strict";var a=require("crossfilter"),b=require("underscore"),c=function(){};c.prototype={crossfilter:null,dimensions:{},socket:null,perPage:0,pageNumber:0,sorting:{key:"",direction:"ascending"},bootstrap:function(a){this.socket=a,a.on("snapshot/perPage",function(a){this.setPerPage(a)}.bind(this)),a.on("snapshot/pageNumber",function(a){this.setPageNumber(a)}.bind(this)),a.on("snapshot/sortBy",function(a){this.setSortBy(a)}.bind(this))},setCollection:function(c){this.crossfilter=a(c);var d=b.keys(c[0]);b.forEach(d,function(a){this.dimensions[a]=this.crossfilter.dimension(function(b){return b[a]})}.bind(this)),this._emitContentUpdated()},_emitContentUpdated:function(){if(this.crossfilter){var a="top";b.contains(["ascending","ascend","asc"],this.sorting.direction)&&(a="bottom");var c=(new Date).getTime(),d=this.dimensions[this.sorting.key][a](1/0),e=d.length,f=e/this.perPage<0?0:Math.ceil(e/this.perPage);if(0!==this.perPage){var g=this.pageNumber-1,h=g*this.perPage;d=d.slice(h,this.perPage+h)}this.socket.emit("snapshot/contentUpdated",{models:d,statistics:{totalPages:isFinite(f)?f:1,totalModels:e,currentPage:this.pageNumber,visibleModels:d.length,perPage:this.perPage||e,sortKey:this.sorting.key,sortDirection:this.sorting.direction},debug:{responseTime:(new Date).getTime()-c}})}},setPerPage:function(a){this.perPage=a,this._emitContentUpdated()},setPageNumber:function(a){this.pageNumber=a,this._emitContentUpdated()},setSortBy:function(a){var b=function(){return"ascending"===this.sorting.direction?"descending":"ascending"}.bind(this);this.sorting={key:a.key,direction:a.direction||b()},this._emitContentUpdated()},applyFilter:function(a,b){var c=this.dimensions[a];this.clearFilter(a),b.call(this,c),this._emitContentUpdated()},clearFilter:function(a){var b=this.dimensions[a];b.filterAll(),this._emitContentUpdated()},clearFilters:function(){b.forEach(this.dimensions,function(a){a.filterAll()}),this._emitContentUpdated()}},module.exports=new c}();